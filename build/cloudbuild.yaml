substitutions:
  _BACKEND_IMAGE: asia-east1-docker.pkg.dev/tagtoo-staging/duke-repo/my-backend

steps:
  - id: build-image
    name: "docker/compose:1.29.2"
    entrypoint: "docker-compose"
    args:
      [
        "-f",
        "docker-compose.yml",
        "build",
        "backend"
      ]
    waitFor: ["-"]
  
  - id: run-services
    name: "docker/compose:1.29.2"
    entrypoint: "docker-compose"
    args:
      [
        "-f",
        "docker-compose.yml",
        "up",
        "-d"
      ]
    waitFor: ["build-image"]
  
  - id: run-gogo-command
    name: "gcr.io/cloud-builders/docker"  # GCP 內建的
    entrypoint: "docker"
    args:
      [
        "exec",
        "my-backend",
        "python", 
        "manage.py", 
        "gogo"
      ]
    waitFor: ["build-image", "run-services"]
  
  - id: run-test
    name: "gcr.io/cloud-builders/docker"
    entrypoint: "docker"
    args:
      [
        "exec",
        "my-backend",
        "pytest",
        "--nomigrations"
      ]
    waitFor: ["build-image", "run-services"]

  - id: retag-backend-image
    name: "gcr.io/cloud-builders/docker"
    entrypoint: "docker"
    args: 
      [
        "tag", 
        "my-backend:latest",
        "${_BACKEND_IMAGE}:${BRANCH_NAME}-${SHORT_SHA}"
      ]
    waitFor: ["run-test"]
  
  - id: push-backend-image
    name: "gcr.io/cloud-builders/docker"
    entrypoint: "docker"
    args: 
      [
        "push", 
        "${_BACKEND_IMAGE}:${BRANCH_NAME}-${SHORT_SHA}"
      ]
    waitFor: ["retag-backend-image"]